# Security baseline for all containers
x-security-base: &security-base
  read_only: true
  cap_drop: ["ALL"]
  security_opt:
    - "no-new-privileges:true"
  tmpfs:
    - /tmp:noexec,nosuid,size=100m
  mem_limit: 512m
  cpus: 0.5

services:
  # General development container for agent workflows
  dev:
    build:
      context: ./containers/dev
      dockerfile: Dockerfile
    <<: *security-base
    working_dir: /workspace
    volumes:
      - ./workspace:/workspace
    environment:
      - NODE_ENV=development
    networks:
      - dev-network
    # override restrictive bits for dev workflow
    read_only: false
    tmpfs:
      - /tmp:noexec,nosuid,size=128m
    mem_limit: 1g
    cpus: 1.0

  # MCP Filesystem server (secure, isolated)
  mcp-fs:
    build:
      context: ./containers/mcp-fs
      dockerfile: Dockerfile
    <<: *security-base
    volumes:
      - ./workspace:/workspace:ro
    network_mode: "none"
    stdin_open: true
    tty: false
    # Very restrictive for MCP tools
    mem_limit: 256m
    cpus: 0.25

  # MCP Shell server (secure, isolated)
  mcp-shell:
    build:
      context: ./containers/mcp-shell
      dockerfile: Dockerfile
    <<: *security-base
    volumes:
      - ./workspace:/workspace
    network_mode: "none"
    stdin_open: true
    tty: false
    # Very restrictive for MCP tools
    mem_limit: 256m
    cpus: 0.25

networks:
  dev-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
